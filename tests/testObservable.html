<html>
 <head>
  <title>Test Page for Observable</title>
  <script src="../vendor/jsunit/app/jsUnitCore.js" type="text/javascript" charset="utf-8"></script>
  <script src="../vendor/prototype/dist/prototype.js" type="text/javascript" charset="utf-8"></script>
  <script src="../vendor/low-pro/dist/lowpro.js" type="text/javascript" charset="utf-8"></script>
  
  <script src="../src/tools.js" type="text/javascript" charset="utf-8"></script>
  <script src="../src/observable.js" type="text/javascript" charset="utf-8"></script>
 </head>
 <body>
  <script language="javascript">
    var User = Class.create(cbObservable, 
    {
      initialize: function($super, username) 
      {
        $super();
        this.defineProperty('username');
        this.defineProperty('password');
        this.defineProperty('is_admin');
        
        this.defineProperty('computer');
        
        this.defineCollectionProperty('friends');

        this.username = username;
      },
      getUsername: function()
      {
        return this._get('username')+' yao!';
      },
      setPassword: function(new_password)
      {
        //Hash the password using an awesome hashing function
        var hash = 0;
        for (var i = new_password.length - 1; i >= 0; i--){
          hash += new_password.charCodeAt(i);
        };
        
        this._set('password', hash);
      },
      isAdmin: function()
      {
        return !this._get('is_admin');
      }
    });

    var Computer = Class.create(cbObservable, 
    {
      initialize: function($super)
      {
        $super();
        
        this.defineProperty('maker');
        this.defineProperty('model');
      }
    });

    var Observer = Class.create(
    {
      initialize: function() 
      {
        this.reset();
      },
      observeValueForKeyPathOfObject: function(key_path, object, change, context)
      {
        this.last_observed_key_paths.push(key_path);
        this.last_observed_objects.push(object);
        this.last_observed_changes.push(change);
        this.last_observed_contexts.push(context);
      },
      reset: function ()
      {
        this.last_observed_key_paths = [];
        this.last_observed_objects = [];
        this.last_observed_changes = [];
        this.last_observed_contexts = [];
      },
      isEmpty: function()
      {
        return (this.last_observed_key_paths.length == 0 &&
                this.last_observed_objects.length == 0 &&
                this.last_observed_changes.length == 0 &&
                this.last_observed_contexts.length == 0);
      }
    });

    function testProperties() 
    {
      var user = new User('magnus');
      assertEquals(user._get('username'), 'magnus');
      assertEquals(user.username, 'magnus yao!');
      user.username = 'mignis';
      assertEquals(user.username, 'mignis yao!');
      
      user.is_admin = true;
      assertFalse(user.is_admin);
      
      user.password = 'qwerty';
      assertEquals(user.password, 684);
    }

    function testKeyValueCoding () 
    {
      var user = new User('magnus');
      var imac = new Computer();
      imac.maker = 'Apple inc.';
      imac.model = 'iMac (Late 2007)';
      
      user.computer = imac;
      
      assertEquals(user.valueForKey('username'), 'magnus yao!');
      assertEquals(user.valueForKeyPath('computer.model'), 'iMac (Late 2007)');
      
      user.setValueForKey('password', 'qwerty');
      user.setValueForKeyPath('computer.model', 'iMac (Early 2010)');
      
      assertEquals(user.valueForKey('password'), 684);
      assertEquals(user.valueForKeyPath('computer.model'), 'iMac (Early 2010)');
      
    }

    function testNonRelationalSettingObservations () 
    {
      var user = new User('magnus');
      user.password = 'qwerty';
      
      var observer = new Observer();
      var observer_2 = new Observer();
      
      user.addObserverForKeyPath(observer, 'username', ['new', 'initial'], {test: 'foo'});
      user.addObserverForKeyPath(observer_2, 'username');

      assertEquals(observer.last_observed_objects[0], user);
      assertEquals(observer.last_observed_key_paths[0], 'username');
      assertEquals(observer.last_observed_changes[0].kind, 'setting')
      assertFalse(observer.last_observed_changes[0].notification_is_prior);
      assertEquals(observer.last_observed_changes[0]['new'], 'magnus yao!');
      assertEquals(observer.last_observed_changes[0].old, undefined);
      assertEquals(observer.last_observed_contexts[0].test, 'foo');
      observer.reset();

      assertTrue(observer_2.isEmpty());
      
      user.username = 'foo';
      assertEquals(observer.last_observed_objects[0], user);
      assertEquals(observer.last_observed_key_paths[0], 'username');
      assertEquals(observer.last_observed_changes[0].kind, 'setting')
      assertFalse(observer.last_observed_changes[0].notification_is_prior);
      assertEquals(observer.last_observed_changes[0]['new'], 'foo yao!');
      assertEquals(observer.last_observed_changes[0].old, undefined);
      assertEquals(observer.last_observed_contexts[0].test, 'foo');
      observer.reset();
      
      assertEquals(observer_2.last_observed_objects[0], user);
      assertEquals(observer_2.last_observed_key_paths[0], 'username');
      assertEquals(observer_2.last_observed_changes[0].kind, 'setting')
      assertFalse(observer_2.last_observed_changes[0].notification_is_prior);
      assertEquals(observer_2.last_observed_changes[0]['new'], undefined);
      assertEquals(observer_2.last_observed_changes[0].old, undefined);
      assertEquals(observer_2.last_observed_contexts[0], undefined);
      observer_2.reset();
      
      user.addObserverForKeyPath(observer, 'password', ['new', 'old', 'prior']);

      user.password = 'foo'; //324

      assertEquals(observer.last_observed_objects[0], user);
      assertEquals(observer.last_observed_key_paths[0], 'password');
      assertEquals(observer.last_observed_changes[0].kind, 'setting')
      assertTrue(observer.last_observed_changes[0].notification_is_prior);
      assertEquals(observer.last_observed_changes[0]['new'], undefined);
      assertEquals(observer.last_observed_changes[0].old, 684);
      
      assertEquals(observer.last_observed_objects[1], user);
      assertEquals(observer.last_observed_key_paths[1], 'password');
      assertEquals(observer.last_observed_changes[1].kind, 'setting')
      assertFalse(observer.last_observed_changes[1].notification_is_prior);
      assertEquals(observer.last_observed_changes[1]['new'], 324);
      assertEquals(observer.last_observed_changes[1].old, 684);
      observer.reset();
      
//      user.password = 'bar'; //309
      
/*      imac.model = 'iMac (Early 2010)';
      assertEquals(observer.last_observed_object, user);
      assertEquals(observer.last_observed_key_path, 'computer.model');*/
      
/*       var imac = new Computer();
      imac.maker = 'Apple inc.';
      imac.model = 'iMac (Late 2007)';
      
      user.computer = imac; */
      
    }
    
    function testNonRelationalArrayObservations () 
    {
      var user = new User('magnus');

      var friend_1 = new User('Friend 1');
      var friend_2 = new User('Friend 2');
      var friend_3 = new User('Friend 3');
      
      user.friends.push(friend_1);
      
      var observer = new Observer();
      
      
    }
    

    testProperties();
    testNonRelationalSettingObservations();
    testKeyValueCoding();
  </script>
 </body>
</html>