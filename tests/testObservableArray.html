<html>
 <head>
  <title>Test Page for Observable Array</title>
  <script src="../vendor/jsunit/app/jsUnitCore.js" type="text/javascript" charset="utf-8"></script>
  <script src="../vendor/prototype/dist/prototype.js" type="text/javascript" charset="utf-8"></script>
  <script src="../vendor/low-pro/dist/lowpro.js" type="text/javascript" charset="utf-8"></script>
  
  <script src="../src/cbObservableArray.js" type="text/javascript" charset="utf-8"></script>
 </head>
 <body>
  <script language="javascript">
    var Observer = Class.create(
    {
      initialize: function() 
      {
        this.reset();
      },
      observeValueForKeyPathOfObject: function(key_path, object, change, context)
      {
        this.last_observed_key_paths.push(key_path);
        this.last_observed_objects.push(object);
        this.last_observed_changes.push(change);
        this.last_observed_contexts.push(context);
      },
      reset: function ()
      {
        this.last_observed_key_paths = [];
        this.last_observed_objects = [];
        this.last_observed_changes = [];
        this.last_observed_contexts = [];
      },
      isEmpty: function()
      {
        return (this.last_observed_key_paths.length == 0 &&
                this.last_observed_objects.length == 0 &&
                this.last_observed_changes.length == 0 &&
                this.last_observed_contexts.length == 0);
      }
    });
  
    function testCollectionUsage() 
    {
      var the_array = new cbObservableArray();
      
      the_array.insertObject('foo');
      assertEquals(the_array.getObjectAtIndex(0), 'foo');
      assertEquals(the_array.count(), 1);
      the_array.insertObjectAtIndex('bar', 1);
      assertEquals(the_array.getObjectAtIndex(1), 'bar');
      assertEquals(the_array.count(), 2);
      the_array.insertObjectAtIndex('quux', 1);
      assertEquals(the_array.getObjectAtIndex(1), 'quux');
      assertEquals(the_array.getObjectAtIndex(2), 'bar');
      assertEquals(the_array.count(), 3);
      
      try 
      {
        the_array.insertObjectAtIndex('quux', 5);
        // We should never reach this.
        assertFalse(true);
      }
      catch (e)
      {
        assertTrue(e instanceof cbOutOfBoundsException);
        assertEquals(the_array.count(), 3);
      }
      
      the_array.removeObjectAtIndex(0);
      assertEquals(the_array.getObjectAtIndex(0), 'quux');
      assertEquals(the_array.count(), 2);
      
      the_array.replaceObjectAtIndex(0, 'burr');
      assertEquals(the_array.getObjectAtIndex(0), 'burr');
      assertEquals(the_array.count(), 2);
    }
    
    function testObservation() 
    {
      var the_array = new cbObservableArray();
      var observer = new Observer();
      
      the_array.insertObject('foo');
      
      the_array.addObserverForKeyPath(observer, 'self', ['new', 'initial'], {test: 'foo'});
      
      assertEquals(observer.last_observed_objects[0], the_array);
      assertEquals(observer.last_observed_key_paths[0], 'self');
      assertEquals(observer.last_observed_changes[0].kind, 'insertion')
      assertFalse(observer.last_observed_changes[0].notification_is_prior);
      assertArrayEquals(observer.last_observed_changes[0]['new'], ['foo']);
      assertArrayEquals(observer.last_observed_changes[0].indexes, [0]);
      assertEquals(observer.last_observed_changes[0].old, undefined);
      observer.reset();
      
      the_array.insertObjectAtIndex('bar', 1);
      assertEquals(observer.last_observed_objects[0], the_array);
      assertEquals(observer.last_observed_key_paths[0], 'self');
      assertEquals(observer.last_observed_changes[0].kind, 'insertion')
      assertFalse(observer.last_observed_changes[0].notification_is_prior);
      assertArrayEquals(observer.last_observed_changes[0]['new'], ['bar']);
      assertArrayEquals(observer.last_observed_changes[0].indexes, [1]);
      assertEquals(observer.last_observed_changes[0].old, undefined);
      observer.reset();
      
      the_array.insertObjectAtIndex('quux', 1);
      assertEquals(observer.last_observed_objects[0], the_array);
      assertEquals(observer.last_observed_key_paths[0], 'self');
      assertEquals(observer.last_observed_changes[0].kind, 'insertion')
      assertFalse(observer.last_observed_changes[0].notification_is_prior);
      assertArrayEquals(observer.last_observed_changes[0]['new'], ['quux']);
      assertArrayEquals(observer.last_observed_changes[0].indexes, [1]);
      assertEquals(observer.last_observed_changes[0].old, undefined);
      observer.reset();
      
      the_array.removeObjectAtIndex(0);
      assertEquals(observer.last_observed_objects[0], the_array);
      assertEquals(observer.last_observed_key_paths[0], 'self');
      assertEquals(observer.last_observed_changes[0].kind, 'removal')
      assertFalse(observer.last_observed_changes[0].notification_is_prior);
      assertEquals(observer.last_observed_changes[0]['new'], undefined);
      assertArrayEquals(observer.last_observed_changes[0].indexes, [0]);
      assertArrayEquals(observer.last_observed_changes[0].old, ['foo']);
      observer.reset();
      
      the_array.replaceObjectAtIndex(0, 'burr');
      assertEquals(observer.last_observed_objects[0], the_array);
      assertEquals(observer.last_observed_key_paths[0], 'self');
      assertEquals(observer.last_observed_changes[0].kind, 'replacement')
      assertFalse(observer.last_observed_changes[0].notification_is_prior);
      assertArrayEquals(observer.last_observed_changes[0]['new'], ['burr']);
      assertArrayEquals(observer.last_observed_changes[0].indexes, [0]);
      assertArrayEquals(observer.last_observed_changes[0].old, ['quux']);
      observer.reset();
    }
    
    testCollectionUsage();
    testObservation();
  </script>
 </body>
</html>